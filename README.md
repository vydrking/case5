## Бот ревьюера кода

Телеграм-бот (frontend) + отдельный сервис инференса (FastAPI, backend). Бот принимает архивы/репозитории, опционально описание/чеклист, и формирует два отчёта:
- Отчёт для студента — найденные проблемы с `file:line` примерами, пошаговые рекомендации для сложных случаев.
- Отчёт для ревьюера — краткая выжимка по той же структуре.

Используется Graph RAG (граф файлов/классов/функций, релевантные фрагменты с номерами строк) и многопроходная проверка правил: длинные описания/чеклисты сжимаются в список правил (легкая модель), затем формируется итог (тяжёлая модель).

## Возможности
- Архивы проекта (.zip/.tar.*; .rar/.7z при наличии внешних утилит) и GitHub-ссылки
- Описание/чеклист: .txt/.md/.yaml/.html (HTML парсится в текст)
- Структурированный отчёт из блоков: «Общие замечания по коду», «Замечания по чеклисту» (если чеклист есть), «Саммари рекомендаций»
- В каждом замечании — 1–3 репрезентативных `file:line`; если проблема массовая — явная пометка и примеры
- Multi-pass анализ правил (rule mining) для длинных документов
- Команда /cancel для отмены текущей операции
- Сообщение о прогрессе «Проект обрабатывается…» удаляется при готовности отчёта

## Архитектура
- Телеграм-бот: `main.py` + пакет `botapp/` (RAG, загрузка архивов, хэндлеры, логику)
- Сервис инференса: `service/app.py` (FastAPI), общение с YandexGPT
- Бот ходит в сервис по HTTP (`INFERENCE_URL`), сервис — в YandexGPT

## Требования
- Python 3.13+
- Токены YandexGPT и Telegram в `.env`
- Для `.7z`/`.rar` по желанию: `p7zip`/`unar`

## Настройка окружения
1) Установите зависимости бота:
```
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```

2) Установите зависимости сервиса инференса:
```
pip install -r service/requirements.txt
```

3) Создайте `.env` в корне проекта:
```
TELEGRAM_BOT_TOKEN='...'
YANDEX_FOLDER_ID='...'
YANDEX_API_KEY='...'
# опционально: путь к дополнительному CA-бандлу
# EXTRA_CA_BUNDLE='/path/to/extra_ca.pem'
```

## Запуск (локально)
1) Запустите сервис инференса (по умолчанию 127.0.0.1:8080):
```
uvicorn service.app:app --host 127.0.0.1 --port 8080
```

2) Запустите бота, указав адрес сервиса:
```
export INFERENCE_URL=http://127.0.0.1:8080
python main.py
```

## Запуск (Docker)
Есть артефакты для контейнеризации сервиса:
- `Dockerfile.service` — образ сервиса
- `docker-compose.yml` — запуск сервиса на :8080

Сборка и запуск:
```
docker compose up -d --build
# затем запустите бота с INFERENCE_URL, указывающим на сервис
export INFERENCE_URL=http://127.0.0.1:8080
python main.py
```

## Как пользоваться
1) Отправьте команду /start — бот попросит чеклист/описание (можно нажать «Без доп. файлов»)
2) Прикрепите чеклист (.txt/.md/.yaml/.html) — бот ответит «Чеклист получен: …»
3) По желанию прикрепите описание — «Описание проекта получено: …»
   - Если нажать «Без доп. файлов» после чеклиста, проверка по чеклисту всё равно будет выполнена
4) Отправьте архив проекта или ссылку на GitHub
5) Бот покажет «Проект обрабатывается…», затем удалит это сообщение и пришлёт два отчёта

Поведение без чеклиста/описания: раздел «Замечания по чеклисту» не выводится, остаются «Общие замечания по коду» и «Саммари рекомендаций».

## Команды бота
- /start — приветствие и инструкции
- /rag — статус RAG и размер контекста
- /cancel — отменить текущую операцию

## Структура репозитория
- `main.py` — инициализация бота, хэндлеры
- `botapp/graph_rag.py` — сбор контекста (Graph RAG), чанкинг с абсолютной нумерацией строк
- `botapp/logic.py` — утилиты: клиппинг, rule-mining, сбор контента
- `botapp/review.py` — функции анализа (если используются напрямую)
- `botapp/handlers.py` — хэндлеры Телеграма
- `botapp/archive.py` — загрузка/распаковка архивов, GitHub clone
- `botapp/http.py` — HTTP-клиент и CA bundle
- `botapp/prompts.py` — базовые промпты
- `service/app.py` — FastAPI сервис инференса (эндпоинты `/health`, `/analyze`, `/multipass`, `/summarize`)
- `Dockerfile.service`, `docker-compose.yml` — контейнеризация сервиса

## Примечания TLS/CA
Запросы выполняются с verify на certifi; при необходимости добавьте `EXTRA_CA_BUNDLE` в `.env`.

## Советы
- Для `.7z`/`.rar` на macOS: `brew install p7zip unar`
- Если бот сообщает про конфликт обновлений Telegram — убедитесь, что токен не используется другим инстансом
